<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abhishek & Sana ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
            authDomain: "abhisanna-232.firebaseapp.com",
            projectId: "abhisanna-232",
            storageBucket: "abhisanna-232.appspot.com",
            messagingSenderId: "472851093145",
            appId: "1:472851093145:web:c6d86d8a7c1e5e5e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'abhishek-sana-forever-v1';

        let currentUser = null;
        let myName = localStorage.getItem('partnerName') || null;

        async function init() {
            if (!myName) {
                document.getElementById('name-overlay').classList.remove('hidden');
                return;
            }
            try {
                await signInAnonymously(auth);
            } catch (error) { console.error("Auth failed:", error); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    startAppLogic();
                }
            });
        }

        window.pickName = (name) => {
            localStorage.setItem('partnerName', name);
            myName = name;
            document.getElementById('name-overlay').classList.add('hidden');
            init();
        };

        async function setupBattery() {
            if (!('getBattery' in navigator)) return;
            const battery = await navigator.getBattery();
            const updateBatteryInDB = async () => {
                if (!currentUser || !myName) return;
                const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName);
                await setDoc(presenceRef, {
                    batteryLevel: Math.round(battery.level * 100),
                    isCharging: battery.charging,
                    online: true,
                    lastSeen: serverTimestamp(),
                    name: myName
                }, { merge: true });
            };
            updateBatteryInDB();
            battery.addEventListener('levelchange', updateBatteryInDB);
            battery.addEventListener('chargingchange', updateBatteryInDB);
        }

        async function fetchWeather() {
            const partnerCity = myName === 'Abhishek' ? 'Jamshedpur' : 'New Delhi';
            const cityDisplay = document.getElementById('city-name');
            const tempDisplay = document.getElementById('temp-display');
            const weatherIcon = document.getElementById('weather-icon');
            try {
                const latLong = myName === 'Abhishek' ? {lat: 22.8046, lon: 86.2029} : {lat: 28.6139, lon: 77.2090};
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latLong.lat}&longitude=${latLong.lon}&current_weather=true`);
                const data = await response.json();
                if (data.current_weather) {
                    tempDisplay.textContent = `${Math.round(data.current_weather.temperature)}¬∞C`;
                    cityDisplay.textContent = partnerCity;
                    weatherIcon.textContent = data.current_weather.weathercode < 4 ? '‚òÄÔ∏è' : '‚òÅÔ∏è';
                }
            } catch (err) { console.error("Weather error:", err); }
        }

        function startAppLogic() {
            document.getElementById('user-display-name').textContent = myName === 'Abhishek' ? 'Sana' : 'Abhishek';
            document.getElementById('msg-input').placeholder = `Message ${myName === 'Abhishek' ? 'Sana' : 'Abhishek'}...`;
            fetchWeather(); setupBattery(); setupChat(); setupDoodle(); setupPresenceListener(); setupVideoSync(); setupHugListener();
            updatePresence(true);
            setInterval(fetchWeather, 1800000);
        }

        async function updatePresence(isOnline) {
            if (!currentUser || !myName) return;
            const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName);
            await setDoc(presenceRef, { online: isOnline, lastSeen: serverTimestamp(), name: myName }, { merge: true });
        }

        function setupPresenceListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name !== myName) {
                        document.getElementById('other-status').textContent = data.online ? 'Online' : 'Offline';
                        if (data.batteryLevel !== undefined) {
                            document.getElementById('battery-text').textContent = `${data.isCharging ? '‚ö°' : 'üîã'} ${data.batteryLevel}%`;
                        }
                    }
                });
            });
        }

        window.sendHugRequest = async () => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hugs', myName), { timestamp: Date.now(), name: myName });
        };

        function setupHugListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'hugs'), (snapshot) => {
                let huggers = [];
                snapshot.forEach(doc => { if (Date.now() - doc.data().timestamp < 30000) huggers.push(doc.data().name); });
                if (huggers.length >= 2) {
                    document.getElementById('hug-overlay').classList.remove('hidden');
                    setTimeout(() => document.getElementById('hug-overlay').classList.add('hidden'), 4000);
                    huggers.forEach(n => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hugs', n)));
                } else if (huggers.length === 1 && huggers[0] !== myName) {
                    document.getElementById('missing-name').textContent = huggers[0];
                    document.getElementById('missing-text').classList.remove('hidden');
                } else {
                    document.getElementById('missing-text').classList.add('hidden');
                }
            });
        }

        async function setupChat() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages');
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMine = msg.sender === myName;
                    const div = document.createElement('div');
                    div.className = `flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-4`;
                    div.innerHTML = `<div class="max-w-[80%] rounded-2xl px-4 py-2 ${isMine ? 'bg-pink-500 text-white rounded-tr-none' : 'bg-white border border-pink-100'} shadow-sm">${msg.text}</div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), { text: input.value, sender: myName, timestamp: serverTimestamp() });
            input.value = '';
        };

        function setupDoodle() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; };
            window.addEventListener('resize', resize); resize();

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDraw = (e) => { drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };
            const endDraw = async () => { if(!drawing) return; drawing = false; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), { image: canvas.toDataURL(), updatedBy: myName }); };
            const moveDraw = (e) => { if (!drawing) return; const pos = getPos(e); ctx.lineWidth = 3; ctx.strokeStyle = '#ec4899'; ctx.lineTo(pos.x, pos.y); ctx.stroke(); };

            canvas.onmousedown = startDraw; canvas.onmouseup = endDraw; canvas.onmousemove = moveDraw;
            canvas.ontouchstart = (e) => { e.preventDefault(); startDraw(e); };
            canvas.ontouchend = (e) => { e.preventDefault(); endDraw(); };
            canvas.ontouchmove = (e) => { e.preventDefault(); moveDraw(e); };

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), (d) => {
                if (d.exists() && d.data().updatedBy !== myName) {
                    const img = new Image(); img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                    img.src = d.data().image;
                }
            });
        }

        function setupVideoSync() {
            window.loadVideo = async () => {
                const val = document.getElementById('vid-id').value;
                const id = val.includes('v=') ? val.split('v=')[1].split('&')[0] : val;
                if (id) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), { id });
            };
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), (d) => {
                if (d.exists()) document.getElementById('player-frame').src = `https://www.youtube.com/embed/${d.data().id}?autoplay=1`;
            });
        }

        window.onbeforeunload = () => updatePresence(false);
        init();
    </script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        body { background: #fff1f2; touch-action: manipulation; }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-2 sm:p-4 overflow-hidden">
    <div id="name-overlay" class="hidden fixed inset-0 z-[100] bg-pink-100 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[40px] shadow-2xl text-center border-4 border-white max-w-sm w-full">
            <h1 class="text-2xl font-black text-pink-500 mb-6">Who's here? ‚ù§Ô∏è</h1>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="pickName('Abhishek')" class="bg-pink-50 py-6 rounded-3xl hover:bg-pink-500 hover:text-white transition-all font-bold">ü§¥ Abhishek</button>
                <button onclick="pickName('Sana')" class="bg-pink-50 py-6 rounded-3xl hover:bg-pink-500 hover:text-white transition-all font-bold">üë∏ Sana</button>
            </div>
        </div>
    </div>

    <div id="hug-overlay" class="hidden fixed inset-0 z-50 bg-pink-500/40 flex items-center justify-center backdrop-blur-md">
        <h1 class="text-white text-4xl font-black animate-bounce">ü´Ç VIRTUAL HUG!</h1>
    </div>

    <div id="missing-text" class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-40 bg-white shadow-xl rounded-full px-6 py-2 border-2 border-pink-500 items-center gap-2">
        <span id="missing-name" class="font-bold text-pink-600 text-sm">Partner</span> <span class="text-gray-600 text-sm">is missing you! ü•∫</span>
    </div>

    <div class="container max-w-6xl w-full h-full sm:h-[90vh] flex flex-col md:flex-row gap-4">
        <div class="flex-1 flex flex-col gap-4 min-h-0">
            <div class="glass rounded-[32px] p-3 sm:p-4 shadow-xl border border-white">
                <div class="flex gap-2 mb-3">
                    <input id="vid-id" type="text" placeholder="YouTube link..." class="flex-1 px-4 py-2 rounded-full text-xs sm:text-sm outline-none bg-white/60">
                    <button onclick="loadVideo()" class="bg-pink-500 text-white px-4 py-2 rounded-full font-bold text-xs sm:text-sm">Sync</button>
                </div>
                <div class="aspect-video bg-black rounded-2xl overflow-hidden border-2 sm:border-4 border-white">
                    <iframe id="player-frame" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>
            <div class="flex-1 glass rounded-[32px] p-4 shadow-xl border border-white relative flex flex-col min-h-0">
                <span class="text-pink-500 font-bold text-xs mb-2">Doodle Pad ‚ú®</span>
                <div class="flex-1 bg-white/80 rounded-[24px] overflow-hidden border border-pink-50 touch-none">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="w-full md:w-[350px] flex flex-col glass rounded-[32px] shadow-xl border border-white overflow-hidden min-h-[400px]">
            <div class="p-4 border-b border-pink-100 flex items-center justify-between bg-white/40">
                <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                        <h2 id="user-display-name" class="font-bold text-gray-800">Partner</h2>
                        <div class="bg-white px-2 py-0.5 rounded-full text-[10px] border border-pink-100 font-bold text-pink-500"><span id="weather-icon">‚òÄÔ∏è</span> <span id="temp-display">--¬∞C</span></div>
                    </div>
                    <div class="flex gap-2 text-[10px] text-gray-400">
                        <span id="other-status">Offline</span>
                        <span id="battery-text">--%</span>
                    </div>
                </div>
                <button onclick="sendHugRequest()" class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-all">üíù</button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col text-sm"></div>
            <div class="p-4 bg-white/40 border-t border-pink-50">
                <div class="flex gap-2">
                    <input id="msg-input" type="text" class="flex-1 py-3 px-5 rounded-full shadow-inner bg-white text-sm outline-none" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-pink-500 w-11 h-11 flex items-center justify-center rounded-full text-white shadow-lg">‚ù§Ô∏è</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>