<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abhishek & Sana ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'abhishek-sana-forever';

        let currentUser = null;
        let myName = localStorage.getItem('partnerName') || null;

        async function init() {
            if (!myName) {
                document.getElementById('name-overlay').classList.remove('hidden');
                return;
            }
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth failed:", error); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    startAppLogic();
                }
            });
        }

        window.pickName = (name) => {
            localStorage.setItem('partnerName', name);
            myName = name;
            document.getElementById('name-overlay').classList.add('hidden');
            init();
        };

        // --- BATTERY TRACKER ---
        async function setupBattery() {
            if (!('getBattery' in navigator)) return;

            const battery = await navigator.getBattery();
            
            const updateBatteryInDB = async () => {
                if (!currentUser || !myName) return;
                const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName);
                await updateDoc(presenceRef, {
                    batteryLevel: Math.round(battery.level * 100),
                    isCharging: battery.charging
                });
            };

            // Initial sync
            updateBatteryInDB();

            // Listen for local changes
            battery.addEventListener('levelchange', updateBatteryInDB);
            battery.addEventListener('chargingchange', updateBatteryInDB);
        }

        // --- WEATHER LOGIC ---
        async function fetchWeather() {
            const partnerCity = myName === 'Abhishek' ? 'Jamshedpur' : 'New Delhi';
            const cityDisplay = document.getElementById('city-name');
            const tempDisplay = document.getElementById('temp-display');
            const weatherIcon = document.getElementById('weather-icon');

            try {
                const latLong = myName === 'Abhishek' ? {lat: 22.8046, lon: 86.2029} : {lat: 28.6139, lon: 77.2090};
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latLong.lat}&longitude=${latLong.lon}&current_weather=true`);
                const data = await response.json();
                
                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    tempDisplay.textContent = `${temp}¬∞C`;
                    cityDisplay.textContent = partnerCity;
                    let icon = '‚òÄÔ∏è';
                    if (code > 0 && code < 4) icon = '‚õÖ';
                    if (code >= 45 && code <= 48) icon = 'üå´Ô∏è';
                    if (code >= 51 && code <= 67) icon = 'üåßÔ∏è';
                    if (code >= 80) icon = '‚õàÔ∏è';
                    weatherIcon.textContent = icon;
                }
            } catch (err) { console.error("Weather error:", err); }
        }

        function startAppLogic() {
            document.getElementById('user-display-name').textContent = myName === 'Abhishek' ? 'Sana' : 'Abhishek';
            document.getElementById('msg-input').placeholder = `Message ${myName === 'Abhishek' ? 'Sana' : 'Abhishek'}...`;
            
            fetchWeather();
            setupBattery();
            setInterval(fetchWeather, 1800000);

            updatePresence(true);
            setupChat();
            setupDoodle();
            setupPresenceListener();
            setupVideoSync();
            setupHugListener();
        }

        // --- PRESENCE & BATTERY LISTENER ---
        async function updatePresence(isOnline) {
            if (!currentUser || !myName) return;
            const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName);
            await setDoc(presenceRef, {
                online: isOnline,
                lastSeen: serverTimestamp(),
                name: myName,
                uid: currentUser.uid
            }, { merge: true });
        }

        function setupPresenceListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'presence');
            onSnapshot(q, (snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name !== myName) {
                        const statusEl = document.getElementById('other-status');
                        const lastSeenEl = document.getElementById('last-seen');
                        const batteryText = document.getElementById('battery-text');
                        
                        statusEl.textContent = data.online ? 'Online' : 'Offline';
                        statusEl.className = data.online ? 'text-green-500 font-bold text-[10px]' : 'text-gray-400 text-[10px]';
                        
                        // Update Battery UI
                        if (data.batteryLevel !== undefined) {
                            const chargingIcon = data.isCharging ? '‚ö°' : 'üîã';
                            batteryText.textContent = `${chargingIcon} ${data.batteryLevel}%`;
                            batteryText.className = `text-[10px] font-bold ${data.batteryLevel < 20 ? 'text-red-500' : 'text-gray-500'}`;
                        }

                        if (!data.online && data.lastSeen) {
                            const date = data.lastSeen.toDate();
                            lastSeenEl.textContent = `Last seen: ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                        } else {
                            lastSeenEl.textContent = '';
                        }
                    }
                });
            });
        }

        // --- HUG LOGIC ---
        window.sendHugRequest = async () => {
            const hugRef = doc(db, 'artifacts', appId, 'public', 'data', 'hugs', myName);
            await setDoc(hugRef, { timestamp: Date.now(), name: myName });
            const btn = document.getElementById('hug-btn');
            btn.classList.add('scale-125', 'bg-red-500');
            setTimeout(() => btn.classList.remove('scale-125', 'bg-red-500'), 1000);
        };

        function setupHugListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'hugs'), (snapshot) => {
                let huggers = [];
                const now = Date.now();
                snapshot.forEach(doc => {
                    if (now - doc.data().timestamp < 30000) huggers.push(doc.data().name);
                });
                if (huggers.length >= 2) {
                    triggerHugAnimation();
                    huggers.forEach(name => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hugs', name)));
                } else if (huggers.length === 1 && huggers[0] !== myName) {
                    document.getElementById('missing-name').textContent = huggers[0];
                    document.getElementById('missing-text').classList.replace('hidden', 'flex');
                } else {
                    document.getElementById('missing-text').classList.replace('flex', 'hidden');
                }
            });
        }

        function triggerHugAnimation() {
            const overlay = document.getElementById('hug-overlay');
            overlay.classList.remove('hidden'); overlay.classList.add('flex');
            setTimeout(() => overlay.classList.add('hidden'), 4000);
        }

        // --- CHAT LOGIC ---
        async function setupChat() {
            const chatContainer = document.getElementById('messages');
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMine = msg.sender === myName;
                    const div = document.createElement('div');
                    div.className = `flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-4`;
                    div.innerHTML = `
                        <div class="max-w-[80%] rounded-2xl px-4 py-2 ${isMine ? 'bg-pink-500 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-pink-100'} shadow-sm">
                            ${msg.text}
                        </div>
                    `;
                    chatContainer.appendChild(div);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                text: input.value, sender: myName, timestamp: serverTimestamp()
            });
            input.value = '';
        };

        // --- DOODLE LOGIC ---
        function setupDoodle() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; };
            window.addEventListener('resize', resize); resize();

            canvas.addEventListener('mousedown', () => drawing = true);
            canvas.addEventListener('mouseup', async () => { 
                drawing = false; ctx.beginPath(); 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), { image: canvas.toDataURL(), updatedBy: myName });
            });
            canvas.addEventListener('mousemove', (e) => {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#ec4899';
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), (doc) => {
                if (doc.exists() && doc.data().updatedBy !== myName) {
                    const img = new Image();
                    img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
                    img.src = doc.data().image;
                }
            });
        }

        // --- VIDEO LOGIC ---
        function setupVideoSync() {
            window.loadVideo = async () => {
                const vidId = document.getElementById('vid-id').value.split('v=')[1] || document.getElementById('vid-id').value;
                if (vidId) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), { id: vidId, timestamp: Date.now() });
            };
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), (doc) => {
                if (doc.exists()) document.getElementById('player-frame').src = `https://www.youtube.com/embed/${doc.data().id}?autoplay=1&enablejsapi=1`;
            });
        }

        window.onbeforeunload = () => updatePresence(false);
        init();
    </script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        body { background: #fff1f2; }
        #messages::-webkit-scrollbar { width: 4px; }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-4">

    <!-- Name Picker -->
    <div id="name-overlay" class="hidden fixed inset-0 z-[100] bg-pink-100 flex items-center justify-center">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl text-center border-4 border-white">
            <h1 class="text-3xl font-black text-pink-500 mb-8">Who's here? ‚ù§Ô∏è</h1>
            <div class="grid grid-cols-2 gap-6">
                <button onclick="pickName('Abhishek')" class="bg-pink-50 p-8 rounded-3xl hover:bg-pink-500 hover:text-white transition-all font-bold">ü§¥ Abhishek</button>
                <button onclick="pickName('Sana')" class="bg-pink-50 p-8 rounded-3xl hover:bg-pink-500 hover:text-white transition-all font-bold">üë∏ Sana</button>
            </div>
        </div>
    </div>

    <!-- Hug & Missing -->
    <div id="hug-overlay" class="hidden fixed inset-0 z-50 bg-pink-500/40 flex items-center justify-center backdrop-blur-md">
        <h1 class="text-white text-6xl font-black animate-pulse">ü´Ç VIRTUAL HUG!</h1>
    </div>
    <div id="missing-text" class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-40 bg-white shadow-xl rounded-full px-6 py-2 border-2 border-pink-500 items-center gap-2">
        <span id="missing-name" class="font-bold text-pink-600">Partner</span> <span class="text-gray-600">is missing you! ü•∫</span>
    </div>

    <div class="container max-w-6xl w-full h-[90vh] flex flex-col md:flex-row gap-4">
        <div class="flex-1 flex flex-col gap-4">
            <!-- YouTube Section -->
            <div class="glass rounded-[32px] p-4 shadow-xl border border-white">
                <div class="flex gap-2 mb-3">
                    <input id="vid-id" type="text" placeholder="Paste YouTube link..." class="flex-1 px-5 py-2 rounded-full border-none shadow-inner bg-white/60 text-sm outline-none">
                    <button onclick="loadVideo()" class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold shadow-lg">Sync Video</button>
                </div>
                <div class="aspect-video bg-black rounded-2xl overflow-hidden border-4 border-white">
                    <iframe id="player-frame" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>
            <!-- Doodle Pad -->
            <div class="flex-1 glass rounded-[32px] p-4 shadow-xl border border-white relative flex flex-col">
                <span class="text-pink-500 font-bold text-xs mb-2">Our Magic Pad ‚ú®</span>
                <div class="flex-1 bg-white/80 rounded-[24px] overflow-hidden border border-pink-50">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Chat & Sidebar -->
        <div class="w-full md:w-[360px] flex flex-col glass rounded-[32px] shadow-xl border border-white overflow-hidden">
            <div class="p-4 border-b border-pink-100 flex items-center justify-between bg-white/40">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center text-2xl">üíç</div>
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <h2 id="user-display-name" class="font-bold text-gray-800">Partner</h2>
                            <div class="flex items-center gap-1 bg-white/80 px-2 py-0.5 rounded-full text-[10px] border border-pink-100 shadow-sm">
                                <span id="weather-icon">‚òÄÔ∏è</span> <span id="temp-display">--¬∞C</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="other-status" class="text-[10px] text-gray-400">Offline</span>
                            <span id="battery-text" class="text-[10px] text-gray-400">--%</span>
                            <span id="city-name" class="text-[9px] text-gray-300"></span>
                        </div>
                        <div id="last-seen" class="text-[9px] text-gray-400"></div>
                    </div>
                </div>
                <button id="hug-btn" onclick="sendHugRequest()" class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-all">üíù</button>
            </div>

            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-white/20"></div>

            <div class="p-4 bg-white/40 border-t border-pink-50">
                <div class="flex gap-2">
                    <input id="msg-input" type="text" class="flex-1 py-3 px-5 rounded-full shadow-inner bg-white text-sm outline-none" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="bg-pink-500 w-11 h-11 flex items-center justify-center rounded-full text-white shadow-xl">‚ù§Ô∏è</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>