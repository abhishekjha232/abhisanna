<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abhishek & Sana ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS for direct connection without Firebase -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); }
        body { background: #fff1f2; font-family: sans-serif; overflow: hidden; }
        canvas { touch-action: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
        .msg-appear { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-2 sm:p-4">

    <!-- Identification Overlay -->
    <div id="setup-overlay" class="hidden fixed inset-0 z-[100] bg-pink-100 flex items-center justify-center p-4">
        <div class="glass p-8 rounded-[40px] shadow-2xl text-center border-4 border-white max-w-sm w-full">
            <h1 class="text-2xl font-black text-pink-500 mb-2">Access Required ‚ù§Ô∏è</h1>
            <p class="text-xs text-gray-400 mb-6">Please use your link to enter.</p>
            <div class="space-y-3">
                <div class="bg-white/50 p-3 rounded-2xl text-left border border-white">
                    <p class="text-[10px] font-bold uppercase text-pink-400">Abhishek's Link:</p>
                    <code class="text-[9px] break-all opacity-60">?user=Abhishek</code>
                </div>
                <div class="bg-white/50 p-3 rounded-2xl text-left border border-white">
                    <p class="text-[10px] font-bold uppercase text-pink-400">Sana's Link:</p>
                    <code class="text-[9px] break-all opacity-60">?user=Sana</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Hug Animation -->
    <div id="hug-overlay" class="hidden fixed inset-0 z-50 bg-pink-500/40 flex items-center justify-center backdrop-blur-md">
        <div class="text-center animate-bounce">
            <span class="text-8xl">ü´Ç</span>
            <h1 class="text-white text-4xl font-black mt-4 drop-shadow-lg">VIRTUAL HUG!</h1>
        </div>
    </div>

    <div class="container max-w-6xl w-full h-full flex flex-col md:flex-row gap-4">
        <div class="flex-1 flex flex-col gap-4 min-h-0">
            <!-- Video Section -->
            <div class="glass rounded-[32px] p-3 shadow-xl border border-white">
                <div class="flex gap-2 mb-2 items-center">
                    <div id="connection-status" class="text-[10px] font-bold text-gray-400 ml-2 bg-white/50 px-3 py-1 rounded-full uppercase tracking-tighter">
                        üì° Offline
                    </div>
                    <input id="vid-id" type="text" placeholder="YouTube URL..." class="flex-1 px-4 py-2 rounded-full text-xs outline-none bg-white">
                    <button id="sync-vid-btn" class="bg-pink-500 text-white px-4 py-2 rounded-full font-bold text-xs active:scale-95 transition-all">Sync</button>
                </div>
                <div class="aspect-video bg-black rounded-2xl overflow-hidden shadow-inner relative">
                    <iframe id="player-frame" class="absolute inset-0 w-full h-full" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>
            <!-- Sketchpad -->
            <div class="flex-1 glass rounded-[32px] p-4 shadow-xl border border-white flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-2 px-2">
                    <span class="text-pink-500 font-bold text-xs italic">Live Sketch ‚ú®</span>
                    <button id="clear-canvas" class="text-[10px] text-gray-400 hover:text-pink-500 transition-colors uppercase font-bold">Clear</button>
                </div>
                <canvas id="canvas" class="flex-1 bg-white rounded-2xl cursor-crosshair border border-pink-50 shadow-inner"></canvas>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="w-full md:w-[350px] flex flex-col glass rounded-[32px] shadow-xl border border-white overflow-hidden min-h-[400px]">
            <div class="p-4 border-b border-pink-100 flex items-center justify-between bg-white/50">
                <div>
                    <h2 id="partner-name" class="font-bold text-gray-800 tracking-tight">Partner</h2>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <span id="other-status" class="text-pink-400">Not Connected</span>
                        <span id="battery-text" class="text-gray-400">--%</span>
                    </div>
                </div>
                <button id="hug-btn" class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl active:scale-90 transition-all border border-pink-50 hover:shadow-pink-100 hover:shadow-xl">üíù</button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2 bg-pink-50/20"></div>
            <div class="p-4 bg-white/60">
                <div class="flex gap-2">
                    <input id="msg-input" type="text" class="flex-1 py-3 px-5 rounded-full bg-white text-sm outline-none border border-pink-50 shadow-sm" placeholder="Message...">
                    <button id="send-btn" class="bg-pink-500 w-11 h-11 flex items-center justify-center rounded-full text-white shadow-lg active:scale-90 transition-all">‚ù§Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const myName = urlParams.get('user');
        const partnerName = myName === 'Abhishek' ? 'Sana' : 'Abhishek';
        
        const peerId = `abhisanna-room-${myName}`;
        const targetPeerId = `abhisanna-room-${partnerName}`;
        
        let peer = null;
        let conn = null;
        let hugActive = false;

        // UI Elements
        const statusEl = document.getElementById('connection-status');
        const partnerStatusEl = document.getElementById('other-status');
        const msgContainer = document.getElementById('messages');
        const msgInput = document.getElementById('msg-input');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        if (!myName || (myName !== 'Abhishek' && myName !== 'Sana')) {
            document.getElementById('setup-overlay').classList.remove('hidden');
        } else {
            document.getElementById('partner-name').textContent = partnerName;
            initPeer();
            setupCanvas();
        }

        function initPeer() {
            // Using a unique ID based on the user name to find each other
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                statusEl.innerHTML = '<span class="text-yellow-500">‚óè</span> Searching...';
                tryConnect();
            });

            peer.on('connection', (incomingConn) => {
                setupConnection(incomingConn);
            });

            peer.on('error', (err) => {
                console.error(err);
                statusEl.innerHTML = '<span class="text-red-500">‚óè</span> Error';
                // Retry after 5 seconds if connection fails
                setTimeout(initPeer, 5000);
            });
        }

        function tryConnect() {
            const outConn = peer.connect(targetPeerId);
            setupConnection(outConn);
        }

        function setupConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                statusEl.innerHTML = '<span class="text-green-500">‚óè</span> Live';
                partnerStatusEl.textContent = 'Online';
                partnerStatusEl.classList.replace('text-pink-400', 'text-green-500');
                
                // Share battery info
                sendBatteryStatus();
            });

            conn.on('data', (data) => {
                handleData(data);
            });

            conn.on('close', () => {
                partnerStatusEl.textContent = 'Offline';
                partnerStatusEl.classList.replace('text-green-500', 'text-pink-400');
                statusEl.innerHTML = '<span class="text-yellow-500">‚óè</span> Reconnecting...';
                setTimeout(tryConnect, 3000);
            });
        }

        function handleData(data) {
            switch(data.type) {
                case 'chat':
                    addMessage(data.text, false);
                    break;
                case 'draw':
                    drawFromPartner(data);
                    break;
                case 'clear':
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    break;
                case 'video':
                    document.getElementById('player-frame').src = `https://www.youtube.com/embed/${data.id}?autoplay=1`;
                    break;
                case 'hug':
                    triggerHug();
                    break;
                case 'battery':
                    document.getElementById('battery-text').textContent = `${data.charging?'‚ö°':''} ${data.level}%`;
                    break;
            }
        }

        // Feature: Chat
        function addMessage(text, isMine) {
            const div = document.createElement('div');
            div.className = `flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-4 msg-appear`;
            div.innerHTML = `<div class="max-w-[80%] rounded-2xl px-4 py-2 ${isMine ? 'bg-pink-500 text-white rounded-tr-none' : 'bg-white border border-pink-100'} shadow-sm">${text}</div>`;
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        document.getElementById('send-btn').onclick = () => {
            const text = msgInput.value.trim();
            if (text && conn && conn.open) {
                conn.send({ type: 'chat', text });
                addMessage(text, true);
                msgInput.value = '';
            }
        };
        msgInput.onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('send-btn').click(); };

        // Feature: Video
        document.getElementById('sync-vid-btn').onclick = () => {
            const val = document.getElementById('vid-id').value;
            const id = val.includes('v=') ? val.split('v=')[1].split('&')[0] : (val.includes('be/') ? val.split('be/')[1] : val);
            if (id && conn && conn.open) {
                conn.send({ type: 'video', id });
                document.getElementById('player-frame').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            }
        };

        // Feature: Hug
        document.getElementById('hug-btn').onclick = () => {
            if (conn && conn.open) {
                conn.send({ type: 'hug' });
                triggerHug();
            }
        };

        function triggerHug() {
            const overlay = document.getElementById('hug-overlay');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.add('hidden'), 4000);
        }

        // Feature: Canvas
        function setupCanvas() {
            let drawing = false;
            const resize = () => { 
                const temp = ctx.getImageData(0,0,canvas.width,canvas.height);
                canvas.width = canvas.offsetWidth; 
                canvas.height = canvas.offsetHeight;
                ctx.putImageData(temp, 0, 0);
            };
            resize(); window.onresize = resize;

            const draw = (e) => {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#ec4899';
                ctx.lineTo(x, y); ctx.stroke();
                
                if (conn && conn.open) {
                    conn.send({ type: 'draw', x, y, start: false });
                }
            };

            const start = (e) => {
                drawing = true; 
                ctx.beginPath(); 
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                ctx.moveTo(x, y);
                if (conn && conn.open) conn.send({ type: 'draw', x, y, start: true });
            };

            canvas.onmousedown = start;
            canvas.ontouchstart = (e) => { start(e); e.preventDefault(); };
            canvas.onmousemove = draw;
            canvas.ontouchmove = (e) => { draw(e); e.preventDefault(); };
            window.onmouseup = () => drawing = false;
            
            document.getElementById('clear-canvas').onclick = () => {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                if (conn && conn.open) conn.send({ type: 'clear' });
            };
        }

        function drawFromPartner(data) {
            if (data.start) {
                ctx.beginPath();
                ctx.moveTo(data.x, data.y);
            } else {
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#f472b6';
                ctx.lineTo(data.x, data.y); ctx.stroke();
            }
        }

        // Feature: Battery
        function sendBatteryStatus() {
            if ('getBattery' in navigator && conn && conn.open) {
                navigator.getBattery().then(bat => {
                    const send = () => conn.send({ type: 'battery', level: Math.round(bat.level*100), charging: bat.charging });
                    send();
                    bat.onlevelchange = send;
                    bat.onchargingchange = send;
                });
            }
        }
    </script>
</body>
</html>