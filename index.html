<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abhishek & Sana ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
            authDomain: "abhisanna-232.firebaseapp.com",
            projectId: "abhisanna-232",
            storageBucket: "abhisanna-232.appspot.com",
            messagingSenderId: "472851093145",
            appId: "1:472851093145:web:c6d86d8a7c1e5e5e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'abhisanna-232';

        // IDENTIFICATION LOGIC (Using URL params)
        const urlParams = new URLSearchParams(window.location.search);
        let myName = urlParams.get('user'); // Expects ?user=Abhishek or ?user=Sana

        function init() {
            if (!myName || (myName !== 'Abhishek' && myName !== 'Sana')) {
                document.getElementById('setup-overlay').classList.remove('hidden');
                return;
            }
            
            document.getElementById('setup-overlay').classList.add('hidden');
            document.getElementById('user-display-name').textContent = myName === 'Abhishek' ? 'Sana' : 'Abhishek';
            
            // Start features
            setupChat(); 
            setupDoodle(); 
            setupPresenceListener(); 
            setupVideoSync(); 
            setupHugListener();
            updatePresence(true);
            
            // Battery Sync
            if ('getBattery' in navigator) {
                navigator.getBattery().then(bat => {
                    const up = () => {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName), {
                            batteryLevel: Math.round(bat.level * 100),
                            isCharging: bat.charging,
                            online: true,
                            lastSeen: Date.now()
                        }, { merge: true }).catch(() => {});
                    };
                    up(); bat.onlevelchange = up; bat.onchargingchange = up;
                });
            }
        }

        async function updatePresence(isOnline) {
            if (!myName) return;
            try {
                const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', myName);
                await setDoc(presenceRef, { 
                    online: isOnline, 
                    lastSeen: Date.now(), 
                    name: myName 
                }, { merge: true });
            } catch (e) { console.error("Presence error", e); }
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !myName) return;
            try {
                const msgText = text;
                input.value = '';
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text: msgText, 
                    sender: myName, 
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Send failed", e); }
        };

        window.sendHugRequest = async () => {
            if (!myName) return;
            const btn = document.getElementById('hug-btn');
            btn.innerHTML = "‚è≥";
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hugs', myName), { 
                    timestamp: Date.now(), 
                    name: myName 
                });
                setTimeout(() => btn.innerHTML = "üíù", 1000);
            } catch (e) { btn.innerHTML = "‚ùå"; }
        };

        window.loadVideo = async () => {
            const val = document.getElementById('vid-id').value;
            const id = val.includes('v=') ? val.split('v=')[1].split('&')[0] : (val.includes('be/') ? val.split('be/')[1] : val);
            if (id && myName) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), { id });
            }
        };

        function setupChat() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages');
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMine = msg.sender === myName;
                    const div = document.createElement('div');
                    div.className = `flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-4`;
                    div.innerHTML = `<div class="max-w-[80%] rounded-2xl px-4 py-2 ${isMine ? 'bg-pink-500 text-white rounded-tr-none' : 'bg-white border border-pink-100'} shadow-sm">${msg.text}</div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function setupDoodle() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            const resize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; };
            resize(); window.onresize = resize;

            const draw = (e) => {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#ec4899';
                ctx.lineTo(x, y); ctx.stroke();
            };

            canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); draw(e); };
            canvas.onmousemove = draw;
            canvas.onmouseup = async () => { 
                drawing = false; 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), { 
                    image: canvas.toDataURL(), 
                    updatedBy: myName 
                });
            };
            
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'doodle', 'current'), (d) => {
                if (d.exists() && d.data().updatedBy !== myName) {
                    const img = new Image();
                    img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
                    img.src = d.data().image;
                }
            });
        }

        function setupPresenceListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snap) => {
                snap.forEach(d => {
                    if (d.id !== myName) {
                        const data = d.data();
                        const isOnline = (Date.now() - (data.lastSeen || 0)) < 15000;
                        document.getElementById('other-status').textContent = isOnline ? 'Online' : 'Offline';
                        if (data.batteryLevel) document.getElementById('battery-text').textContent = `${data.isCharging?'‚ö°':''} ${data.batteryLevel}%`;
                    }
                });
            });
        }

        function setupVideoSync() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sync', 'video'), (d) => {
                if (d.exists()) document.getElementById('player-frame').src = `https://www.youtube.com/embed/${d.data().id}?autoplay=1`;
            });
        }

        function setupHugListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'hugs'), (snap) => {
                let count = 0;
                snap.forEach(d => { if(Date.now() - d.data().timestamp < 10000) count++; });
                if (count >= 2) {
                    document.getElementById('hug-overlay').classList.remove('hidden');
                    setTimeout(() => document.getElementById('hug-overlay').classList.add('hidden'), 3000);
                }
            });
        }

        window.onload = init;
    </script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        body { background: #fff1f2; font-family: sans-serif; overflow: hidden; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-2 sm:p-4">
    <!-- Links Setup Overlay -->
    <div id="setup-overlay" class="hidden fixed inset-0 z-[100] bg-pink-100 flex items-center justify-center p-4">
        <div class="glass p-8 rounded-[40px] shadow-2xl text-center border-4 border-white max-w-sm w-full">
            <h1 class="text-2xl font-black text-pink-500 mb-2">Private Access ‚ù§Ô∏è</h1>
            <p class="text-xs text-gray-400 mb-6">You must use your unique personal link to enter the space.</p>
            <div class="space-y-3">
                <div class="bg-white/50 p-3 rounded-2xl text-left border border-white">
                    <p class="text-[10px] font-bold uppercase text-pink-400 mb-1">Abhishek's Link:</p>
                    <code class="text-[9px] break-all opacity-60">.../index.html?user=Abhishek</code>
                </div>
                <div class="bg-white/50 p-3 rounded-2xl text-left border border-white">
                    <p class="text-[10px] font-bold uppercase text-pink-400 mb-1">Sana's Link:</p>
                    <code class="text-[9px] break-all opacity-60">.../index.html?user=Sana</code>
                </div>
            </div>
            <p class="mt-6 text-[10px] text-gray-400">Add <b>?user=Name</b> to the end of your browser URL.</p>
        </div>
    </div>

    <!-- Hug Overlay -->
    <div id="hug-overlay" class="hidden fixed inset-0 z-50 bg-pink-500/40 flex items-center justify-center backdrop-blur-md">
        <div class="text-center animate-bounce">
            <span class="text-8xl">ü´Ç</span>
            <h1 class="text-white text-4xl font-black mt-4">VIRTUAL HUG!</h1>
        </div>
    </div>

    <div class="container max-w-6xl w-full h-full flex flex-col md:flex-row gap-4">
        <div class="flex-1 flex flex-col gap-4 min-h-0">
            <div class="glass rounded-[32px] p-3 shadow-xl border border-white">
                <div class="flex gap-2 mb-2">
                    <input id="vid-id" type="text" placeholder="Paste YouTube link..." class="flex-1 px-4 py-2 rounded-full text-xs outline-none bg-white/60">
                    <button onclick="loadVideo()" class="bg-pink-500 text-white px-4 py-2 rounded-full font-bold text-xs active:scale-95">Sync</button>
                </div>
                <div class="aspect-video bg-black rounded-2xl overflow-hidden shadow-inner border border-white/50">
                    <iframe id="player-frame" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
            </div>
            <div class="flex-1 glass rounded-[32px] p-4 shadow-xl border border-white flex flex-col min-h-0">
                <span class="text-pink-500 font-bold text-xs mb-2 italic text-center">Sketch pad ‚ú®</span>
                <canvas id="canvas" class="flex-1 bg-white/50 rounded-2xl cursor-crosshair touch-none border border-pink-50"></canvas>
            </div>
        </div>

        <div class="w-full md:w-[350px] flex flex-col glass rounded-[32px] shadow-xl border border-white overflow-hidden min-h-[400px]">
            <div class="p-4 border-b border-pink-100 flex items-center justify-between bg-white/50">
                <div>
                    <h2 id="user-display-name" class="font-bold text-gray-800">Partner</h2>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <span id="other-status" class="text-pink-400">Searching...</span>
                        <span id="battery-text" class="text-gray-400">--%</span>
                    </div>
                </div>
                <button id="hug-btn" onclick="sendHugRequest()" class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-90 transition-all border border-pink-50">üíù</button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2 bg-pink-50/20"></div>
            <div class="p-4 bg-white/50">
                <div class="flex gap-2">
                    <input id="msg-input" type="text" class="flex-1 py-3 px-5 rounded-full shadow-inner bg-white text-sm outline-none border border-pink-50" onkeypress="if(event.key === 'Enter') sendMessage()" placeholder="Send a heart...">
                    <button onclick="sendMessage()" class="bg-pink-500 w-11 h-11 flex items-center justify-center rounded-full text-white shadow-lg active:scale-90">‚ù§Ô∏è</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>